name: Deploy to Vercel

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Link Vercel project and set env vars
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Get or create project
          PROJECT=$(curl -s -X POST "https://api.vercel.com/v9/projects" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name":"bee-doo-portal","framework":"nextjs"}')
          
          PROJECT_ID=$(echo "$PROJECT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('id',''))" 2>/dev/null)
          if [ -z "$PROJECT_ID" ]; then
            PROJECT_ID=$(curl -s "https://api.vercel.com/v9/projects/bee-doo-portal" \
              -H "Authorization: Bearer $VERCEL_TOKEN" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('id',''))")
          fi
          
          ORG_ID=$(curl -s "https://api.vercel.com/v2/user" \
            -H "Authorization: Bearer $VERCEL_TOKEN" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['user']['id'])")
          
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
          echo "ORG_ID=$ORG_ID" >> $GITHUB_ENV
          
          mkdir -p .vercel
          echo "{\"projectId\":\"$PROJECT_ID\",\"orgId\":\"$ORG_ID\"}" > .vercel/project.json
          echo "Linked project: $PROJECT_ID"
          
          # Set env vars - first list existing to get IDs for deletion
          EXISTING=$(curl -s "https://api.vercel.com/v9/projects/$PROJECT_ID/env" \
            -H "Authorization: Bearer $VERCEL_TOKEN")
          
          # Delete old vars and set fresh ones
          for KEY in NEXT_PUBLIC_SUPABASE_URL NEXT_PUBLIC_SUPABASE_ANON_KEY NEXT_PUBLIC_APP_URL SUPABASE_SERVICE_ROLE_KEY; do
            ENV_ID=$(echo "$EXISTING" | python3 -c "
import sys,json
d=json.load(sys.stdin)
envs=d.get('envs',[])
for e in envs:
    if e.get('key')=='$KEY':
        print(e.get('id',''))
        break
" 2>/dev/null)
            if [ -n "$ENV_ID" ]; then
              curl -s -X DELETE "https://api.vercel.com/v9/projects/$PROJECT_ID/env/$ENV_ID" \
                -H "Authorization: Bearer $VERCEL_TOKEN" > /dev/null
            fi
          done
          
          # Add env vars
          curl -s -X POST "https://api.vercel.com/v9/projects/$PROJECT_ID/env" \
            -H "Authorization: Bearer $VERCEL_TOKEN" -H "Content-Type: application/json" \
            -d "[
              {\"key\":\"NEXT_PUBLIC_SUPABASE_URL\",\"value\":\"https://hqzpemfaljxcysyqssng.supabase.co\",\"type\":\"plain\",\"target\":[\"production\",\"preview\"]},
              {\"key\":\"NEXT_PUBLIC_SUPABASE_ANON_KEY\",\"value\":\"$ANON_KEY\",\"type\":\"plain\",\"target\":[\"production\",\"preview\"]},
              {\"key\":\"NEXT_PUBLIC_APP_URL\",\"value\":\"https://bee-doo-portal.vercel.app\",\"type\":\"plain\",\"target\":[\"production\",\"preview\"]},
              {\"key\":\"SUPABASE_SERVICE_ROLE_KEY\",\"value\":\"$SERVICE_KEY\",\"type\":\"encrypted\",\"target\":[\"production\",\"preview\"]}
            ]" | python3 -c "import sys,json; d=json.load(sys.stdin); print('Env vars set:', len(d) if isinstance(d,list) else d.get('error','?'))"

      - name: Deploy to Vercel (remote build)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ env.ORG_ID }}
          VERCEL_PROJECT_ID: ${{ env.PROJECT_ID }}
        run: |
          DEPLOY_URL=$(vercel --prod --yes --token=$VERCEL_TOKEN)
          echo "ðŸš€ Deployed: $DEPLOY_URL"
          echo "### Portal live: $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY
