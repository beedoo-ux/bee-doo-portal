name: Run Portal Migrations

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'supabase/migrations/**'

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run SQL migrations via Supabase Management API
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          REF="hqzpemfaljxcysyqssng"
          
          run_sql() {
            local FILE="$1"
            echo "Running: $FILE"
            RESULT=$(curl -s -X POST "https://api.supabase.com/v1/projects/$REF/database/query" \
              -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"query\": $(cat "$FILE" | python3 -c "import sys,json; print(json.dumps(sys.stdin.read()))")}")
            echo "$RESULT"
            if echo "$RESULT" | grep -q '"error"'; then
              echo "⚠️ Warning in $FILE (may already exist)"
            else
              echo "✅ $FILE applied"
            fi
          }
          
          for f in supabase/migrations/*.sql; do
            run_sql "$f"
          done
